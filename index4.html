<!DOCTYPE html>
<html>
<head></head>
<body>

<!-- https://CodeSolutions2.github.io/on_the_way_to_selfrespect/index2.html -->
<h1 style='text-align: center; margin-bottom: -35px;'>On the way to self-respect webapp</h1>
<br><br>

<button id="run_it_button" onclick="run_it()" style="display:block">run_it</button>

<!-- Output text -->
<div id="output" style="font-family:courier;font-size:24px;height:300px"></div>

<br><br>

<button id="user_click_done" onclick="user_click_done()" style="display:none">DONE</button>
	
<style>
      canvas {border: 1px solid black;}
</style>
	
  
  <script>

// -------------------------------------------------

var squarelocation = [0, 1, 2, 3, 4, 5, 6];
	  
// Set the width and height of the canvas
var canvasElement_width = 150;
var canvasElement_height = canvasElement_width;

const outp = document.getElementById('output');

var user_click = [];
var order = [];
	  
// ----------------------------
// Create all the elements
// ----------------------------
var canvasElement0 = document.createElement('canvas');
var ctx0 = canvasElement0.getContext("2d");  // Get the 2D rendering context of the canvas

var canvasElement1 = document.createElement('canvas');
var ctx1 = canvasElement1.getContext("2d");

var canvasElement2 = document.createElement('canvas');
var ctx2 = canvasElement2.getContext("2d");  // Get the 2D rendering context of the canvas

var canvasElement3 = document.createElement('canvas');
var ctx3 = canvasElement3.getContext("2d");  // Get the 2D rendering context of the canvas

var canvasElement4 = document.createElement('canvas');
var ctx4 = canvasElement4.getContext("2d");  // Get the 2D rendering context of the canvas

var canvasElement5 = document.createElement('canvas');
var ctx5 = canvasElement5.getContext("2d");  // Get the 2D rendering context of the canvas

var canvasElement6 = document.createElement('canvas');
var ctx6 = canvasElement6.getContext("2d");  // Get the 2D rendering context of the canvas


// -------------------------------------------------



// -------------------------------------------------


async function initialization_of_canvasElements() {

	canvasElement0.width = canvasElement_width;
	canvasElement0.height = canvasElement_height;
	canvasElement1.width = canvasElement_width;
	canvasElement1.height = canvasElement_height;
	canvasElement2.width = canvasElement_width;
	canvasElement2.height = canvasElement_height;
	canvasElement3.width = canvasElement_width;
	canvasElement3.height = canvasElement_height;
	canvasElement4.width = canvasElement_width;
	canvasElement4.height = canvasElement_height;
	canvasElement5.width = canvasElement_width;
	canvasElement5.height = canvasElement_height;
	canvasElement6.width = canvasElement_width;
	canvasElement6.height = canvasElement_height;

	// Location style: row
	canvasElement0.style.left = Number(0*canvasElement_width + 40)+'px';
	canvasElement1.style.left = Number(1*canvasElement_width + 40)+'px';
	canvasElement2.style.left = Number(2*canvasElement_width + 40)+'px';
	canvasElement3.style.left = Number(3*canvasElement_width + 40)+'px';
	canvasElement4.style.left = Number(4*canvasElement_width + 40)+'px';
	canvasElement5.style.left = Number(5*canvasElement_width + 40)+'px';
	canvasElement6.style.left = Number(6*canvasElement_width + 40)+'px';

	// Location sytle: triangle
	// Location sytle: square
	// Location sytle: 5 sides
	// Location sytle: hexagon
	// Location style: 7 sides

	// Add the canvas to the document body or any other desired element
	document.body.appendChild(canvasElement0);
	document.body.appendChild(canvasElement1);
	document.body.appendChild(canvasElement2);
	document.body.appendChild(canvasElement3);
	document.body.appendChild(canvasElement4);
	document.body.appendChild(canvasElement5);
	document.body.appendChild(canvasElement6); 

	// Make all the canvas context objects a certain initial color
	ctx0.fillStyle = '#999c98';  // Background square over image = blue
	ctx0.fillRect(0, 0, canvasElement_width, canvasElement_height);
	ctx1.fillStyle = '#999c98';  // Background square over image = blue
	ctx1.fillRect(0, 0, canvasElement_width, canvasElement_height);
	ctx2.fillStyle = '#999c98';  // Background square over image = blue
	ctx2.fillRect(0, 0, canvasElement_width, canvasElement_height);
	ctx3.fillStyle = '#999c98';  // Background square over image = blue
	ctx3.fillRect(0, 0, canvasElement_width, canvasElement_height);
	ctx4.fillStyle = '#999c98';  // Background square over image = blue
	ctx4.fillRect(0, 0, canvasElement_width, canvasElement_height);
	ctx5.fillStyle = '#999c98';  // Background square over image = blue
	ctx5.fillRect(0, 0, canvasElement_width, canvasElement_height);
	ctx6.fillStyle = '#999c98';  // Background square over image = blue
	ctx6.fillRect(0, 0, canvasElement_width, canvasElement_height);
}



// -------------------------------------------------

	  
async function run_it() {

	// -------------------------------------------------
	
	var user_click = [];
	console.log("user_click in run_it: ", user_click);

	// Reset screen text
	outp.innerHTML = "";

	var order = await initialization_of_canvasElements()
		.then(async function() { var order = await flash_sequence_difficulty3(); return order;})
		.then(async function(order) { await allow_some_color_to_be_seen(); return order;})
		.then(async function(order) { await listen_for_user_clicks(); localStorage.setItem("order", order); return order;})
		;

	// now, need a way to determine when the user is done click 
	// monitor the length of the array that holds the user clicks: the user knows that they need to click on 3 even 
	// OR let user click a button to say they are done
	
	// -------------------------------------------------
	
	return order;
	
}  // end of run_it


// -------------------------------------------------

async function allow_some_color_to_be_seen() {
	// ctx.fillStyle = "rgb(0 0 200 / 50%)";  // Background square over image = blue

	// Make all the canvas context objects a certain initial color
	ctx0.fillStyle = '#999c98';  // Background color
	ctx0.fillRect(0, 0, canvasElement_width, canvasElement_height/2);
	ctx1.fillStyle = '#999c98';  // Background color
	ctx1.fillRect(0, 0, canvasElement_width, canvasElement_height/2);
	ctx2.fillStyle = '#999c98';  // Background color
	ctx2.fillRect(0, 0, canvasElement_width, canvasElement_height/2);
	ctx3.fillStyle = '#999c98';  // Background color
	ctx3.fillRect(0, 0, canvasElement_width, canvasElement_height/2);
	ctx4.fillStyle = '#999c98';  // Background color
	ctx4.fillRect(0, 0, canvasElement_width, canvasElement_height/2);
	ctx5.fillStyle = '#999c98';  // Background color
	ctx5.fillRect(0, 0, canvasElement_width, canvasElement_height/2);
	ctx6.fillStyle = '#999c98';  // Background color
	ctx6.fillRect(0, 0, canvasElement_width, canvasElement_height/2);

	
} 

// -------------------------------------------------

// Exploit the onclick with the button
async function user_click_done() {

	console.log("user_click in user_click_done: ", user_click); // user_click = undefined

	// The first stop_one_eventlister has the correct user_click
	return await stop_listening_for_user_clicks()
		.then(async function() { await verify_user_clicks(); })
		.then(async function() { user_click = []; return user_click; });
}
	  
// -------------------------------------------------


async function listen_for_user_clicks() {

	// Launch eventListeners on all of the canvasElements
	await start_one_eventlister(0)
		.then(async function() {outp.innerHTML = "Click on the same pattern that was presented, then click the 'DONE' button."; await start_one_eventlister(1); })
		.then(async function() { await start_one_eventlister(2); })
		.then(async function() { await start_one_eventlister(3); })
		.then(async function() { await start_one_eventlister(4); })
		.then(async function() { await start_one_eventlister(5); })
		.then(async function() { await start_one_eventlister(6); })
	;

	// Make the DONE button visible
	document.getElementById("user_click_done").style = 'block';

}

// -------------------------------------------------



async function stop_listening_for_user_clicks() {
	
	// Launch eventListeners on all of the canvasElements
	await stop_one_eventlister(0)
		.then(async function() { await stop_one_eventlister(1); })
		.then(async function() { await stop_one_eventlister(2); })
		.then(async function() { await stop_one_eventlister(3); })
		.then(async function() { await stop_one_eventlister(4); })
		.then(async function() { await stop_one_eventlister(5); })
		.then(async function() { await stop_one_eventlister(6); })
	;

}

	  
// -------------------------------------------------


async function verify_user_clicks(){
	
	// Remove DONE button
	document.getElementById("user_click_done").style = 'none';

	// ------------------------
	console.log('order global variable: ', order);
	
	// make order a string
	var order = localStorage.getItem("order");
	console.log('order localStorage: ', order);
	
	const order_string = order.toString();
	// ------------------------

	// ------------------------
	user_click = [... new Set(user_click)]; // remove repeating values due to addeventlisterner handle
	console.log('user_click in verify_user_clicks: ', user_click);
	// localStorage.setItem("user_click", user_click);
	// OR
	const user_click_string = user_click.toString();
	
	// Reset user_click
	user_click = [];

	// const user_click_string = localStorage.getItem("user_click").toString();
	// ------------------------

	if (order_string == user_click_string) {
		// Correct 
		outp.innerHTML = "Correct: the pattern was " + order_string + ", you performed " + user_click_string;
	} else {
		outp.innerHTML = "Incorrect: the pattern was " + order_string + ", you performed " + user_click_string;
	}

}


// -------------------------------------------------
	

async function get_number(x) {
	return x[Math.round(x.length*Math.random())-1];
}

	  
async function rand_perm(x, vec_len) {

	var out = [];
	while (out.length != vec_len) {
		out = await get_number(x).then(async function(x_of_y) {
			if (out.includes(x_of_y) == false && typeof x_of_y != "undefined") { 
				out.push(x_of_y);
			}
			return [... new Set(out)]; // ensure that only unique values are stored in out
		});
	}
	
	return out;
	
}  // end of rand_perm
	  
// -------------------------------------------------

async function flash_sequence_difficulty3(){

	var order = await rand_perm(squarelocation, 3)
		.then(async function(order) { await show_one_image_square(order.at(0)); return order; })
		.then(async (order) => { await new Promise(r => setTimeout(r, 2000)); return order;})
		.then(async function(order) { await show_one_grey_square(order.at(0)); return order;})
		.then(async function(order) { await show_one_image_square(order.at(1)); return order; })
		.then(async (order) => { await new Promise(r => setTimeout(r, 2000)); return order;})
		.then(async function(order) { await show_one_grey_square(order.at(1)); return order;})
		.then(async function(order) { await show_one_image_square(order.at(2)); return order; })
		.then(async (order) => { await new Promise(r => setTimeout(r, 2000)); return order;})
		.then(async function(order) { await show_one_grey_square(order.at(2)); return order; })
		;

	return order;
} 

	  
// -------------------------------------------------


async function flash_sequence_when_clicked_on(val){

	await show_one_image_square(val)
		.then(async (val) => { await new Promise(r => setTimeout(r, 1000)); return val;})
		.then(async function(val) { await show_one_grey_square(val); })
		;

} 
	  
// -------------------------------------------------
	  
async function show_one_image_square(val) {
	
	    const image = new Image();
	
	    image.setAttribute('crossOrigin', "");
	    image.setAttribute('headers', {"Content-Type": "application/json", "Access-Control-Allow-Origin": "*"});
	    
	    if (val == 0) {
		image.onload = async () => { ctx0.drawImage(image, 0, 0, canvasElement_width, canvasElement_height); };  // end of image.onload
		image.src = "https://storage.googleapis.com/on-the-way2selfrespect/red.png";
	    } else if (val == 1) {
		image.onload = async () => { ctx1.drawImage(image, 0, 0, canvasElement_width, canvasElement_height); };  // end of image.onload
		image.src = "https://storage.googleapis.com/on-the-way2selfrespect/green.png";
	    } else if (val == 2) {
		image.onload = async () => { ctx2.drawImage(image, 0, 0, canvasElement_width, canvasElement_height); };  // end of image.onload
		image.src = "https://storage.googleapis.com/on-the-way2selfrespect/blue.png";
	    } else if (val == 3) {
		image.onload = async () => { ctx3.drawImage(image, 0, 0, canvasElement_width, canvasElement_height); };  // end of image.onload
		image.src = "https://storage.googleapis.com/on-the-way2selfrespect/cyan.png";
	    } else if (val == 4) {
		image.onload = async () => { ctx4.drawImage(image, 0, 0, canvasElement_width, canvasElement_height); };  // end of image.onload
		image.src = "https://storage.googleapis.com/on-the-way2selfrespect/yellow.png";
	    } else if (val == 5) {
		image.onload = async () => { ctx5.drawImage(image, 0, 0, canvasElement_width, canvasElement_height); };  // end of image.onload
		image.src = "https://storage.googleapis.com/on-the-way2selfrespect/magenta.png";
	    } else {
		image.onload = async () => { ctx6.drawImage(image, 0, 0, canvasElement_width, canvasElement_height); };  // end of image.onload
		image.src = "https://storage.googleapis.com/on-the-way2selfrespect/orange.png";
	    }
  
}  // end of show_one_image_square

// -------------------------------------------------


async function show_one_grey_square(val) {
	
    // Draw image on canvas
    if (val == 0) {
	ctx0.fillStyle = '#999c98';  // Background square over image = blue
	ctx0.fillRect(0, 0, canvasElement_width, canvasElement_height);
    } else if (val == 1) {
	ctx1.fillStyle = '#999c98';  // Background square over image = blue
	ctx1.fillRect(0, 0, canvasElement_width, canvasElement_height);
    } else if (val == 2) {
	ctx2.fillStyle = '#999c98';  // Background square over image = blue
	ctx2.fillRect(0, 0, canvasElement_width, canvasElement_height);
    } else if (val == 3) {
	ctx3.fillStyle = '#999c98';  // Background square over image = blue
	ctx3.fillRect(0, 0, canvasElement_width, canvasElement_height);
    } else if (val == 4) {
	ctx4.fillStyle = '#999c98';  // Background square over image = blue
	ctx4.fillRect(0, 0, canvasElement_width, canvasElement_height);
    } else if (val == 5) {
	ctx5.fillStyle = '#999c98';  // Background square over image = blue
	ctx5.fillRect(0, 0, canvasElement_width, canvasElement_height);
    } else {
	ctx6.fillStyle = '#999c98';  // Background square over image = blue
	ctx6.fillRect(0, 0, canvasElement_width, canvasElement_height);
    }
	
}  // end of show_grey_square

	  
// -------------------------------------------------


var newHandle = function(event) { handle(event, user_click.push(localStorage.getItem("val"));); };
	  
async function start_one_eventlister(val) {

	console.log("user_click in start_one_eventlister: ", user_click);
	localStorage.setItem("val", val);
	
    // Start an eventlister per canvas to evaluate user response
    if (val == 0) {
	// canvasElement0.addEventListener("click", (event) => { user_click.push(val); }, false); // it duplicates each val by the number of time "run it" is pushed, meaning that the handle is not deleted everytime eventlistener is removed??
	// OR
	canvasElement0.addEventListener("click", newHandle, false);
    } else if (val == 1) {
	// canvasElement1.addEventListener("click", (event) => { user_click.push(val); }, false);
	// OR
	canvasElement1.addEventListener("click", newHandle, false);
    } else if (val == 2) {
	// canvasElement2.addEventListener("click", (event) => { user_click.push(val); }, false);
	// OR
	canvasElement2.addEventListener("click", newHandle, false);
    } else if (val == 3) {
	// canvasElement3.addEventListener("click", (event) => { user_click.push(val); }, false);
	// OR
	canvasElement3.addEventListener("click", newHandle, false);
    } else if (val == 4) {
	// canvasElement4.addEventListener("click", (event) => { user_click.push(val); }, false);
	// OR
	canvasElement4.addEventListener("click", newHandle, false);
    } else if (val == 5) {
	// canvasElement5.addEventListener("click", (event) => { user_click.push(val); }, false);
	// OR
	canvasElement5.addEventListener("click", newHandle, false);
    } else {
	// canvasElement6.addEventListener("click", (event) => { user_click.push(val); }, false);
	// OR
	canvasElement6.addEventListener("click", newHandle, false);
    }
	
}  // end of start_one_eventlister

	  
// -------------------------------------------------


async function stop_one_eventlister(val) {

    console.log("user_click in stop_one_eventlister: ", user_click);
	
    // Start an eventlister per canvas to evaluate user response
    if (val == 0) {
	canvasElement0.removeEventListener("click", (event) => { });
    } else if (val == 1) {
	canvasElement1.removeEventListener("click", (event) => { });
    } else if (val == 2) {
	canvasElement2.removeEventListener("click", (event) => { });
    } else if (val == 3) {
	canvasElement3.removeEventListener("click", (event) => { });
    } else if (val == 4) {
	canvasElement4.removeEventListener("click", (event) => { });
    } else if (val == 5) {
	canvasElement5.removeEventListener("click", (event) => { });
    } else {
	canvasElement6.removeEventListener("click", (event) => { });
    }
	
}  // end of start_one_eventlister

	  
// -------------------------------------------------
	

	
</script>
</body>
</html>
