<!DOCTYPE html>
<html>
<head></head>
<body>

<h1 style='text-align: center; margin-bottom: -35px;'>Test to receive and send files</h1>
  <br><br>

	
<!-- https://developer.mozilla.org/en-US/docs/Web/HTML/Element/div -->
<!-- https://CodeSolutions2.github.io/on_the_way_to_selfrespect/index.html -->

<button id="sendreceive_files_GCP_image" onclick="sendreceive_files_GCP_image()" style="display:block">sendreceive_files_GCP_image</button>
	
<button id="sendreceive_files_GCP_form" onclick="sendreceive_files_GCP_form()" style="display:block">sendreceive_files_GCP_form</button>

<button id="sendreceive_files_GCP_fetch" onclick="sendreceive_files_GCP_fetch()" style="display:block">sendreceive_files_GCP_fetch</button>

<!-- View results -->
<div id="output" style="font-family:courier;font-size:24px;height:300px"></div>
	
<style>
      canvas {border: 1px solid black;}
</style>
	
  
  <script>
	  
// -------------------------------------------------
	  
const outp = document.getElementById('output');

// -------------------------------------------------

// Way 0: Use image.onload to perform GET to obtain an image from GCP
async function sendreceive_files_GCP_image() {
	
		// -------------------------------------------------

		var canvasElement = document.createElement('canvas');
		canvasElement.width = 100;
		canvasElement.height = canvasElement.width;
		var ctx = canvasElement.getContext("2d");
		ctx.fillStyle = '#999c98';  // Background square over image = blue
		ctx.fillRect(0, 0, canvasElement.width, 50);  // fillRect(x, y, width, height);
		document.body.appendChild(canvasElement);

		// -------------------------------------------------
		
		let url = 'https://storage.googleapis.com/on-the-way2selfrespect/blue.png';
		
		// -------------------------------------------------

		const image = new Image();
		
		image.setAttribute('crossOrigin', "");

		// This works
		image.setAttribute('headers', {"Content-Type": "application/json", "Access-Control-Allow-Origin": "*"});

		// image.setAttribute('headers', {"Content-Type": "application/json"});
	
		image.onload = async () => {
	
		// Draw image on canvas
		ctx.drawImage(image, 0,0);

		    // Write image name on canvas
		    ctx.font = "bold 14px serif";
		    let out = url.split("/")
		    let image_name = out[out.length-1];
		    ctx.fillStyle = "#ffffff";  // Font color = white, 
		    ctx.fillText(image_name, 10, 15);
        
		};  // end of image.onload

		image.src = url;

}  // end of sendreceive_files_GCP_image
	  
// -------------------------------------------------

// Way 1: Use a form to perform GET to obtain an image from GCP
// Form has to be called with one level from main page - can not be called in a function-in-a-function

// https://developer.mozilla.org/en-US/docs/Learn/Forms/Sending_and_retrieving_form_data
async function sendreceive_files_GCP_form() {
	
  // Create <form> element to submit parameters to endpoint
  var form = document.createElement('form');
	
  form.setAttribute('method', 'GET'); 

  // Step 0: The browser navigates to the URL given in the action attribute : the user is taken away from the current page and redirected to a new page.
  // The action attribute is used to indicate where the form’s data is sent to when it is submitted.
  var url = 'https://storage.googleapis.com/on-the-way2selfrespect';
  form.setAttribute('action', url);


  // The form submission result will open in a new tab or window, depending on the user's browser settings.
  // form.setAttribute('target', "_blank");
	
  form.setAttribute('headers', {"Content-Type": "application/json", "Access-Control-Allow-Origin": "*"});

	preventDefault
  
  // Just use arrays: each column is a form variable
  let type_parameters = ['text', 'submit'];
  var name_parameters = ['key', 'confirm_submit'] 
  var value_parameters = ['blue.png', 'Submit'];
	
  type_parameters.forEach(async function(type_val, index) {
	  let type = type_val;
	  let name = name_parameters[index];
	  let value = value_parameters[index];
	  
    var input = document.createElement('input');
    input.innerHTML = '<input style="display:none;" type=' +type+ ' name=' +name+ 'value=' +value+ '>';

		// https://storage.googleapis.com/textclassification-w-labeled-data?keytype%3D%22text%22=train_dataset0.csv
		// https://storage.googleapis.com/textclassification-w-labeled-data?keyvalue%3Dtrain_dataset0.csv=
          
     form.appendChild(input);
    });

  // Add form to page and submit it to open the endpoint.
  document.body.appendChild(form);
	
  form.submit();
  
}  // end of sendreceive_files_GCP_form

// -----------------------------------


// https://stackoverflow.com/questions/30601620/adding-an-event-listener-to-an-element-that-doesnt-exist-yet-in-vanilla-javascr
// https://stackoverflow.com/questions/42542300/how-to-stay-on-the-same-page-after-clicking-submit-button

// Add an eventlistener to a button, when the button is clicked, do not redirect AND output the form results
// Do not redirect page to the page that we want to perform GET,POST requests with
document.getElementById("sendreceive_files_GCP_form").addEventListener("click", (event) => {
	event.preventDefault();
	onsubmit_get_result();
});
	  
// OR

// It is listening for any clicks on the page now, and if it receives a click on 
// document.addEventListener('click', (event) => {
	// Check if the page click is on a certain element
// 	var element = event.target;
// 	if(element.classList.contains("sendreceive_files_GCP_form")){
// 		onsubmit_get_result();
// 	}
// });

	  
// -----------------------------------

	  
function onsubmit_get_result() {

	outp.innerHTML += "data sent";

      // -------------------
      // Save form data AFTER the GET request
      // -------------------

      // Read from the submitted form
      // Display the key/value pairs on the form before and AFTER the GET/POST
      var formObject = document.getElementById("form");
      var form_elements = formObject.elements;

      for (var i=0; i<form_elements.length; i++){
        var key_value_pair = form_elements[i]; 
        console.log(key_value_pair.name, key_value_pair.value);
      }
	// https://storage.googleapis.com/on-the-way2selfrespect/blue.png?keyvalue%3Dblue.png=
}

// -------------------------------------------------


// Uses formData and fetch to contact the server - but I am trying to get form to work in the first place, because I can not get fetch to work. If fetch worked, I would just use fetch.
	  
// https://www.javascript-coder.com/javascript-form/javascript-submit-form-stay-on-page/

// -------------------------------------------------

// Way 2: Use a fetch to perform GET to obtain an image from GCP
async function sendreceive_files_GCP_fetch() {

	let url = 'https://storage.googleapis.com/on-the-way2selfrespect/blue.png';

	// The server should set this , "Access-Control-Allow-Credentials": true
	let headers = {"Content-Type": "application/json", "Access-Control-Allow-Origin": "*", "Access-Control-Allow-Credentials": true};


	// referrerPolicy: 
	// "origin"    // failed to do Cross-Origin Request
	// "unsafe-url"  //Ignoring the less restricted referrer policy “unsafe-url” for the cross-site request (failed to do Cross-Origin Request)
	// "cross-origin"
	// 
	//Connection': 'keep-alive'
	
	let options = {method : 'GET', 
		       headers: headers, 
		       mode: 'cors', 
		       cache: "no-cache", 
		       credentials: "include", 
		       redirect: "follow", 
		       referrerPolicy: "origin"};


	try {
		await fetch(url, options).then(res => res.json()).then(imageout => {
	
			console.log('imageout:', imageout);
	
		  }).catch(error => { outp.innerHTML += error; });

	} catch (error) {
      document.getElementById("outData").innerHTML = error; 
      // return error
    }
	 

}  // end of sendreceive_files_GCP_fetch

// -------------------------------------------------

	
</script>
</body>
</html>
