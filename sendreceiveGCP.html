<!DOCTYPE html>
<html>
<head></head>
<body>

<h1 style='text-align: center; margin-bottom: -35px;'>Test to receive and send image files</h1>
  <br><br>

	
<!-- https://developer.mozilla.org/en-US/docs/Web/HTML/Element/div -->
<!-- https://CodeSolutions2.github.io/on_the_way_to_selfrespect/index.html -->

<button id="sendreceive_files_GCP_image" onclick="sendreceive_files_GCP_image()" style="display:block">sendreceive_files_GCP_image</button>
	
<button id="sendreceive_files_GCP_form" onclick="sendreceive_files_GCP_form()" style="display:block">sendreceive_files_GCP_form</button>
<button id="onsubmit_get_result" onclick="onsubmit_get_result()" style="display:block">onsubmit_get_result</button>

<button id="sendreceive_files_GCP_fetch_forIMAGES" onclick="sendreceive_files_GCP_fetch_forIMAGES()" style="display:block">sendreceive_files_GCP_fetch_forIMAGES</button>
<!-- View results -->
<div id="output" style="font-family:courier;font-size:24px;height:300px"></div>
	
<style>
      canvas {border: 1px solid black;}
</style>
	
  
  <script>
	  
// -------------------------------------------------
	  
const outp = document.getElementById('output');

// -------------------------------------------------

// Way 0: Use image.onload to perform GET to obtain an image from GCP
async function sendreceive_files_GCP_image() {
	
		// -------------------------------------------------

		var canvasElement = document.createElement('canvas');
		canvasElement.width = 100;
		canvasElement.height = canvasElement.width;
		var ctx = canvasElement.getContext("2d");
		ctx.fillStyle = '#999c98';  // Background square over image = blue
		ctx.fillRect(0, 0, canvasElement.width, 50);  // fillRect(x, y, width, height);
		document.body.appendChild(canvasElement);

		// -------------------------------------------------
		
		let url = 'https://storage.googleapis.com/on-the-way2selfrespect/blue.png';
		
		// -------------------------------------------------

		const image = new Image();
		
		image.setAttribute('crossOrigin', "");

		// This works
		image.setAttribute('headers', {"Content-Type": "application/json", "Access-Control-Allow-Origin": "*"});

		// image.setAttribute('headers', {"Content-Type": "application/json"});
	
		image.onload = async () => {
	
		// Draw image on canvas
		ctx.drawImage(image, 0,0);

		    // Write image name on canvas
		    ctx.font = "bold 14px serif";
		    let out = url.split("/")
		    let image_name = out[out.length-1];
		    ctx.fillStyle = "#ffffff";  // Font color = white, 
		    ctx.fillText(image_name, 10, 15);
        
		};  // end of image.onload

		image.src = url;

}  // end of sendreceive_files_GCP_image
	  
// -------------------------------------------------

// Way 1: Use a form to perform GET to obtain an image from GCP
// Form has to be called with one level from main page - can not be called in a function-in-a-function

// https://developer.mozilla.org/en-US/docs/Learn/Forms/Sending_and_retrieving_form_data
async function sendreceive_files_GCP_form() {
	
  // Create <form> element to submit parameters to endpoint
  var form = document.createElement('form');
	
  form.setAttribute('method', 'GET'); 

  // Step 0: The browser navigates to the URL given in the action attribute : the user is taken away from the current page and redirected to a new page.
  // The action attribute is used to indicate where the form’s data is sent to when it is submitted.
  var url = 'https://storage.googleapis.com/on-the-way2selfrespect';
  form.setAttribute('action', url);


  // The form submission result will open in a new tab or window, depending on the user's browser settings.
  // form.setAttribute('target', "_blank");
	
  form.setAttribute('headers', {"Content-Type": "application/json", "Access-Control-Allow-Origin": "*"});
  
  // Just use arrays: each column is a form variable
  let type_parameters = ['text', 'submit'];
  var name_parameters = ['key', 'confirm_submit'] 
  var value_parameters = ['blue.png', 'Submit'];
	
  type_parameters.forEach(async function(type_val, index) {
	  let type = type_val;
	  let name = name_parameters[index];
	  let value = value_parameters[index];
	  
    var input = document.createElement('input');
    input.innerHTML = '<input style="display:none;" type=' +type+ ' name=' +name+ 'value=' +value+ '>';
          
     form.appendChild(input);
    });

  // Add form to page and submit it to open the endpoint.
  document.body.appendChild(form);
	
  form.submit();
  
}  // end of sendreceive_files_GCP_form

// https://cloud.google.com/storage/docs/using-cors#command-line
// https://tr.javascript.info/fetch-crossorigin
// https://html.form.guide/html-form/form-action-using-javascript-function/

//  Successful form response
// Disable Cache
// 3 requests
// 2.18 kB / 3.72 kB transferred
// Finish: 364 ms
// DOMContentLoaded: 163 ms
// load: 254 ms
	
// GET
	
// scheme 	https
// host		www.google.com
// filename 		/images/icons/product/cloud_storage-32.png
// Address 		[2a00:1450:4007:810::2004]:443
// Status 		200
// VersionHTTP/3
// Transferred1.50 kB (850 B size)
// Referrer Policystrict-origin-when-cross-origin
// DNS ResolutionSystem
	  
// accept-ranges 		bytes
// alt-svc 		h3=":443"; ma=2592000,h3-29=":443"; ma=2592000
// cache-control 	private, max-age=31536000
// content-length 		850
// content-type 		image/png
// cross-origin-opener-policy-report-only 	same-origin; report-to="static-on-bigtable"
// cross-origin-resource-policy: cross-origin
// date 		Mon, 26 Feb 2024 17:27:10 GMT
// expires 		Mon, 26 Feb 2024 17:27:10 GMT
// last-modified 	Tue, 22 Oct 2019 18:30:00 GMT
// report-to 	{"group":"static-on-bigtable","max_age":2592000,"endpoints":[{"url":"https://csp.withgoogle.com/csp/report-to/static-on-bigtable"}]}
// server 	sffe
// x-content-type-options 		nosniff
// x-xss-protection 		0
// Accept 		image/avif,image/webp,*/*
// Accept-Encoding 		gzip, deflate, br
// Accept-Language 		en-US,en;q=0.5
// Connection 			keep-alive
// DNT 			1
// Host 		www.google.com
// Referer 		https://storage.googleapis.com/
// Sec-Fetch-Dest 		image
// Sec-Fetch-Mode 		no-cors
// Sec-Fetch-Site 		cross-site
// Sec-GPC 		1
// TE 		trailers
// User-Agent 		Mozilla/5.0 (X11; Linux x86_64; rv:120.0) Gecko/20100101 Firefox/120.0


// -----------------------------------


// https://stackoverflow.com/questions/30601620/adding-an-event-listener-to-an-element-that-doesnt-exist-yet-in-vanilla-javascr
// https://stackoverflow.com/questions/42542300/how-to-stay-on-the-same-page-after-clicking-submit-button

// Add an eventlistener to a button, when the button is clicked, do not redirect AND output the form results
// Do not redirect page to the page that we want to perform GET,POST requests with
document.getElementById("sendreceive_files_GCP_form").addEventListener("click", (event) => {
	event.preventDefault();
});
	  
// OR

// It is listening for any clicks on the page now, and if it receives a click on 
// document.addEventListener('click', (event) => {
	// Check if the page click is on a certain element
// 	var element = event.target;
// 	if(element.classList.contains("sendreceive_files_GCP_form")){
// 		onsubmit_get_result();
// 	}
// });

	  
// -----------------------------------

	  
function onsubmit_get_result() {

	outp.innerHTML += "data sent";

      // -------------------
      // Save form data AFTER the GET request
      // -------------------

      // Read from the submitted form
      // Display the key/value pairs on the form before and AFTER the GET/POST
      var formObject = document.getElementById("form");
      var form_elements = formObject.elements;

      for (var i=0; i<form_elements.length; i++){
        var key_value_pair = form_elements[i]; 
        console.log(key_value_pair.name, key_value_pair.value);
      }
	// https://storage.googleapis.com/on-the-way2selfrespect/blue.png?keyvalue%3Dblue.png=
}

// -------------------------------------------------


// Uses formData and fetch to contact the server - but I am trying to get form to work in the first place, because I can not get fetch to work. If fetch worked, I would just use fetch.
	  
// https://www.javascript-coder.com/javascript-form/javascript-submit-form-stay-on-page/

// -------------------------------------------------

// Way 2: Use a fetch to perform GET to obtain an image from GCP
async function sendreceive_files_GCP_fetch_forIMAGES() {

	let url = 'https://storage.googleapis.com/on-the-way2selfrespect/blue.png';

	// The server should set this , "Access-Control-Allow-Credentials": true
	let headers = {"Content-Type": "image/png", 
		       "Access-Control-Allow-Origin": "*", 
		       "Access-Control-Allow-Credentials": true,
		       "Connection": "keep-alive"};


	// referrerPolicy: 
	// "origin"    // for cross origin url
	// "unsafe-url"  //Ignoring the less restricted referrer policy “unsafe-url” for the cross-site request (failed to do Cross-Origin Request)
	// "cross-origin"
	// 
	// Sec-Fetch-Site 		cross-site
	// https://fetch.spec.whatwg.org/#http-cors-protocol
	// https://developer.mozilla.org/en-US/docs/Web/HTML/CORS_enabled_image
	// https://developer.mozilla.org/en-US/docs/Web/HTML/Attributes/crossorigin
	
	let options = {method : 'GET', 
		       headers: headers, 
		       mode: 'cors', 
		       cache: "no-cache", 
		       credentials: "include", 
		       redirect: "follow", 
		       referrerPolicy: "origin"};


	try {
		await fetch(url, options).then(res => res.json()).then(imageout => {
			console.log('imageout:', imageout);
		  }).catch(error => { outp.innerHTML += error; });

		// OR

		img_res = await fetch(url, options);
		img = await img_res.text();
		
		// document.querySelector("#img" + i).src = img;
		// OR
		const img1 = new Image();
		img1.src = img;
		document.body.appendChild(img1);

	} catch (error) {
      document.getElementById("outData").innerHTML = error; 
      // return error
    }
	 

}  // end of sendreceive_files_GCP_fetch_forIMAGES


// -------------------------------------------------

	
</script>
</body>
</html>
